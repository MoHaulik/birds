<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR Seagulls with Positional Audio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body { margin: 0; overflow: hidden; }
    </style>
  </head>
  <body>
    <!-- Include Three.js and the ARButton helper -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/examples/jsm/webxr/ARButton.js"></script>
    <script>
      // Create scene, camera, and renderer with AR enabled.
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);
      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

      // Add a simple light.
      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      light.position.set(0.5, 1, 0.25);
      scene.add(light);

      // Set up an audio listener and attach it to the camera.
      const listener = new THREE.AudioListener();
      camera.add(listener);

      // -------------------------------------------
      // Function: Create a voxel seagull mesh
      // (Adapted from your A-Frame component)
      // -------------------------------------------
      function createSeagullMesh() {
        const material = new THREE.MeshStandardMaterial({
          side: THREE.DoubleSide,
          vertexColors: true
        });

        const geometry = new THREE.BufferGeometry();

        // Position attribute – scaled by 0.01.
        const positions = [
          -100,100,-200, -50,100,-150, -50,100,-217, 50,100,-217, -50,100,-50,
          50,100,-50, 100,100,-200, 50,100,-150, -50,100,50, -50,100,-19,53,-6,
          -17,46,58, 50,100,50, 17,46,58, 19,53,-6, 50,100,-50, -350,100,-50,
          -250,125,-25, -250,125,25, -250,125,25, -317,133,17, -350,100,-50,
          -250,125,-25, -150,125,-25, -150,125,25, -250,125,25, -150,125,-25,
          -50,100,-50, -50,100,50, -150,125,25, 150,125,25, 50,100,50, 50,100,-50,
          150,125,-25, 250,125,25, 150,125,25, 150,125,-25, 250,125,-25, 317,133,17,
          250,125,25, 250,125,-25, 250,125,-25, 350,100,-50, 317,133,17, -18,68,143,
          -12,38,143, 18,68,143, 12,38,143, -7,57,188, -18,68,143, -12,38,143,
          -5,45,188, 7,57,188, 5,45,188, 12,38,143, 18,68,143
        ].map(v => v * 0.01);
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));

        // Normal attribute.
        const normals = [
           0,1,0, 0,1,0, 0,1,0, 0,1,0, 0,1,0, 0,1,0, 0,1,0, 0,1,0,
          -0.5,0.3,0.7, -0.4,0.3,-0.9, -0.3,-0.8,-0.4, -0.6,-0.8,-0.1,
           0.5,0.4,0.8, 0.6,-0.8,0, 0.5,-0.8,-0.3, 0.3,0.5,-0.8,
           0,-1,0.2, 0,-1,0.2, 0,-1,0.2, 0,-0.9,0.3, 0,-0.9,0.3,
           0,-0.9,0.3, 0,-1,0, 0, -1,0, 0,-1,0, 0,-1,0, -0.2,-1,0,
          -0.2,-1,0, -0.2,-1,0, -0.2,-1,0, 0.2,-1,0, 0.2,-1,0, 0.2,-1,0,
           0.2,-1,0, 0, -1,0, 0, -1,0, 0,-1,0, 0,-1,0, 0,-1,0, 0, -1,0.2,
           0,-1,0.2, 0,-1,0.2, 0,-0.9,0.3, 0,-0.9,0.3, 0,-0.9,0.3,
          -0.8,0.4,0.4, -0.7,-0.8,0.1, 0.5,0.8,0.4, 0.7,-0.7,0,
          -0.8,0.4,0.4, -0.8,0.4,0.4, -0.7,-0.8,0.1, -0.5,-0.8,0.3,
           0.4,0.8,0.4, 0.8,-0.5,0.3, 0.7,-0.7,0, 0.5,0.8,0.4
        ];
        geometry.setAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));

        // Color attribute.
        const colors = [
          1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1,
          1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1,
          0,0,0, 0.5,0.5,0.5, 0.5,0.5,0.5, 0.5,0.5,0.5, 0,
          0,0, 0,0,0, 0.5,0.5,0.5, 1,1,1, 1,1,1, 0.5,0.5,0.5,
          1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1,
          0.5,0.5,0.5, 1,1,1, 1,1,1, 0.5,0.5,0.5, 0,0,0,
          0.5,0.5,0.5, 0.5,0.5,0.5, 0.5,0.5,0.5, 0,0,0, 0,0,0,
          1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1, 1,1,1,
          0.2,0.1,1, 0.2,0.1,1, 0.2,0.1,1, 0.2,0.1,1, 0.2,0.1,1,
          0.2,0.1,1, 0.2,0.1
        ];
        geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

        // Index data.
        const indices = [
           0,0,1,1,2,0, 3,2,4,4,5,3, 6,3,7,7,6,6,8,9,10,10,11,8,
          12,13,14,14,15,12, 13,11,10,10,14,13,15,9,8,8,12,15,9,15,14,
          14,10,9, 16,17,18,19,20,21,22,23,24,24,25,22, 26,27,28,28,29,26,
          30,31,32,32,33,30, 34,35,36,36,37,34, 38,39,40,41,42,43,44,8,11,
          11,45,44,46,47,13,13,12,46,47,45,11,11,13,47,46,12,8,8,44,46,
          48,49,50,50,51,48, 52,53,54,54,55,52, 53,51,50,50,54,53,52,55,
          49,49,48,52,53,52,48,48,51,53
        ];
        geometry.setIndex(indices);
        geometry.addGroup(0, 138, 0);
        geometry.computeBoundingBox();

        return new THREE.Mesh(geometry, material);
      }

      // -------------------------------------------------
      // Create several seagull (bird) objects in the scene.
      // Each bird is given a random starting position, a simple velocity,
      // and a PositionalAudio node loaded with “bird.ogg”.
      // -------------------------------------------------
      const numBirds = 5;
      const birds = [];
      for (let i = 0; i < numBirds; i++) {
        const bird = createSeagullMesh();
        bird.position.set(
          (Math.random() - 0.5) * 4,
          Math.random() * 2 + 1,
          (Math.random() - 0.5) * 4
        );
        bird.userData.velocity = new THREE.Vector3(
          (Math.random() - 0.5) * 0.01,
          (Math.random() - 0.5) * 0.01,
          (Math.random() - 0.5) * 0.01
        );

        // Create a positional audio object and load the bird sound.
        const audioLoader = new THREE.AudioLoader();
        const sound = new THREE.PositionalAudio(listener);
        audioLoader.load('bird.ogg', function(buffer) {
          sound.setBuffer(buffer);
          sound.setLoop(true);
          sound.setRefDistance(1);
          sound.setVolume(0.5);
          sound.play();
        });
        bird.add(sound);
        scene.add(bird);
        birds.push(bird);
      }

      // -------------------------------------------------
      // Animation loop: update bird positions and render the scene.
      // -------------------------------------------------
      renderer.setAnimationLoop(function() {
        birds.forEach(bird => {
          bird.position.add(bird.userData.velocity);
          // Reverse direction if a bird goes out of a ±5 meter boundary.
          ['x', 'y', 'z'].forEach(axis => {
            if (bird.position[axis] < -5 || bird.position[axis] > 5) {
              bird.userData.velocity[axis] *= -1;
            }
          });
        });
        renderer.render(scene, camera);
      });

      // Handle window resizing.
      window.addEventListener('resize', function() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>
  </body>
</html>
